---
title: "false_color_imagery"
format: html
---

```{r, message=FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tmap)
library(tmaptools)
```

## Loading data- For Pre Fire Data
```{r}
# Set directory for folder
pre_fire_dir <- here::here("data","data 6", "LC80340322016189-SC20170128091153")

# Create a list of all images that have the extension .tif and contain the word band
pre_fire_bands <- list.files(pre_fire_dir,
                             pattern = glob2rx("*band*.tif$"),
                             full.names = TRUE)
# Create a raster stack
pre_fire_rast <- rast(pre_fire_bands)

# Read mask raster
pre_mask <- rast(here::here('data',"data 6", "LC80340322016189-SC20170128091153", "LC80340322016189LGN00_cfmask_crop.tif"))
```

## Loading data- For Pre Fire Data
```{r}
# Set directory for folder
post_fire_dir <- here::here('data',"data 6", "LC80340322016205-SC20170127160728")

# Create a list of all images that have the extension .tif and contain the word band
post_fire_bands <- list.files(post_fire_dir,
                             pattern = glob2rx("*band*.tif$"),
                             full.names = TRUE)
# Create a raster stack
post_fire_rast <- rast(post_fire_bands)

# Read mask raster
post_mask <- rast(here::here('data',"data 6","LC80340322016205-SC20170127160728", "LC80340322016205LGN00_cfmask_crop.tif"))
```

# Define the **nbr_fun** function to calculate the normalized burn ratio (NBR):
```{r}
# Using Band 5- Near Infrared and Band 7 - Short-Wave Infrared 2 (SWIR2)
nbr_fun <- function(nir, swir2){
  #(Band 5 -Band 7) and (Band 5 - Band 7) 
    (nir - swir2)/(nir + swir2)
}
```

## 2. Rename and mask the bands
`Extreme cloud cover and shadows can make the data in those areas, un-usable given reflectance values are either washed out (too bright - as the clouds scatter all light back to the sensor) or are too dark (shadows which represent blocked or absorbed light)”`

- Rename the bands of the pre_fire and post_fire rasters using names()
```{r}
# Renaming bands with this list
bands <- c("Aerosol", "Blue", "Green", "Red", "NIR", "SWIR1", "SWIR2")
# assining bands to both fire bands (post and pre)
names(pre_fire_rast) <- bands
names(post_fire_rast) <- bands
```

- Mask out clouds and shadows of the pre_mask and post_mask rasters **(i.e., set mask > 0 to NA)**
```{r}
# Set all cells with values greater than 0 to NA
pre_mask[pre_mask > 0] <- NA

# Subset raster based on mask
pre_fire_rast <- mask(pre_fire_rast, mask = pre_mask)

# View raster
plot(pre_fire_rast)
```

```{r}
# Set all cells with values greater than 0 to NA
post_mask[post_mask > 0] <- NA

# Subset raster based on mask
post_fire_rast <- mask(post_fire_rast, mask = post_mask)

# View raster
plot(post_fire_rast)
```

## 3. Plot true and false color composites

`#To make an informed choice about whether to apply a linear stretch or histogram equalization, check the distribution of reflectance values of the bands in each raster:`

- Plot a true color composite using plotRGB()
Map the red band to the red channel, green to green, and blue to blue
-Apply a linear stretch “lin” or histogram equalization “hist”

```{r}
plotRGB(pre_fire_rast, r = 4, g = 3, b = 2, stretch = "lin", colNA = "black")
```

```{r}
plotRGB(post_fire_rast, r = 4, g = 3, b = 2, stretch = "lin", colNA = "black")
```

- Plot two false color composite using `plotRGB()`
- Map the SWIR2 band to the red channel, NIR to green, and green to blue
- Apply a linear stretch “lin” or histogram equalization “hist”
`What is the SWIR, NIR, Red false color scheme?
“Combining SWIR, NIR, and Red bands highlights the presence of vegetation, clear-cut areas and bare soils, active fires, and smoke; in a false color image” (EOS Data Analytics)`

```{r}
plotRGB(pre_fire_rast, r = 7, g = 5, b = 3, stretch = "lin", colNA = "black")
```
```{r}
plotRGB(post_fire_rast, r = 7, g = 5, b = 3, stretch = "lin", colNA = "black")
```

# 4. Calculate the normalized burn ratio (NBR)
Calculate the normalized burn ratio (NBR)
*Hint: Use lapp() like you previously did for NDVI and NDWI in Week 4*
```{r}
pre_nbr_rast <- terra::lapp(pre_fire_rast[[c(5, 7)]], fun = nbr_fun)

plot(pre_nbr_rast, main = "Cold Springs Pre-Fire NBR", colNA = "black")
```

```{r}
post_nbr_rast <- terra::lapp(post_fire_rast[[c(5, 7)]], fun = nbr_fun)

plot(post_nbr_rast, main = "Cold Springs Post-Fire NBR", colNA = "black")
```
# 6. Calculate and plot difference NBR
- Find the difference NBR, where 
- Plot the dnBR raster
```{r}
diff_nbr <- pre_nbr_rast - post_nbr_rast

tm_shape(diff_nbr) +
tm_raster(col.scale = tm_scale_continuous(values = "scico.roma", midpoint = 30))
```

# 5. Bonus challenge: Classify severeity levels of burn
- Use classify() to assign the severity levels below:
Severity Level      	dNBR Range
Enhanced Regrowth	      < -.1
Unburned	            -.1 to +.1
Low Severity        	+.1 to +.27
Moderate Severity   	+.27 to +.66
High Severity         	> .66

```{r}
# Set categories for severity levels
categories <- c("Enhanced Regrowth", "Unburned", "Low Severity", "Moderate Severity", "High Severity")

# Create reclassification matrix
rcl <- matrix(c(-Inf, -0.1, 1, # group 1 ranges for Enhanced Regrowth
                -0.1, 0.1, 2, # group 2 ranges for Unburned
                0.1, 0.27, 3, # group 3 ranges for Low Severity
                0.27, 0.66, 4, # group 4 ranges for Moderity Severity
                0.66, Inf, 5), # group 5 ranges for High Severity
                ncol = 3, byrow = TRUE)

# Use reclassification matrix to reclassify dNBR raster
reclassified <- classify(diff_nbr, rcl = rcl)

reclassified[is.nan(reclassified)] <- NA
```

```{r}
tm_shape(reclassified) +
  tm_raster()+
  tm_layout(legend.outside = TRUE)
```

