---
title: "week3_Practice_vector_operations"
format: html
---

```{r}
library(here)
library(tidyverse)
library(sf)
library(tmap)
```

```{r}
sb_protected_areas <- st_read(here("data","wk3", "cpad_super_units_sb.shp")) |>  
  st_transform("ESRI:102009")

sb_city_boundaries <- st_read(here("data","wk3", "sb_city_boundaries_2003.shp")) |> 
  st_transform("ESRI:102009")

sb_county_boundary <- st_read(here("data","wk3", "sb_county_boundary_2020.shp")) |> 
  st_transform("ESRI:102009")

aves <- st_read(here("data","wk3","aves_observations_2020_2024.shp")) |> 
  st_transform("ESRI:102009")
```

## Find bird observations within PAs in Santa Barbara County
Find how many bird observations are within protected areas in Santa Barbara County and show how your output differs with a spatial subset versus a spatial join
```{r}
# checking values in columns for protected areas
#unique(sb_protected_areas)
# Subset 
aves_PA_subset <- sb_protected_areas[aves, ] 
# Check # of rows
nrow(aves_PA_subset)
```

```{r}
tm_shape(sb_county_boundary) +
  tm_fill() +
  tm_shape(sb_protected_areas) +
    tm_borders(lwd = 1, col = "#fb8500") +
    tm_fill(col = "#fb8500", alpha = 0.2) +
  tm_shape(aves_PA_subset) +
    tm_dots(col = "#023047")
```

```{r}
aves_PA_join <- st_join(aves, sb_protected_areas) # default: `st_intersects` 

nrow(aves_PA_join) # Check number of rows
```


```{r}
tm_shape(sb_county_boundary) +
  tm_fill() +
  tm_shape(sb_protected_areas) +
    tm_borders(lwd = 1, col = "#fb8500") +
    tm_fill(col = "#fb8500", alpha = 0.2) +
  tm_shape(aves_PA_join) +
    tm_dots(col = "#023047")
```

- Make a 5 km buffer around the protected areas and subset buffered geometries to only those with bird observations
```{r}
# Check if units are in meters
st_crs(sb_protected_areas)$units 
```

```{r}
# Create 5000 m buffer around PAs
PA_buffer_5km <- st_buffer(sb_protected_areas, dist = 5000) 
```

```{r}
aves_buffer_subset <- PA_buffer_5km[aves, ] # Subset

nrow(aves_buffer_subset) # Check number of rows
```

```{r}
tm_shape(sb_county_boundary) +
  tm_fill() +
  tm_shape(sb_protected_areas) +
    tm_borders(lwd = 1, col = "#fb8500") +
    tm_fill(col = "#fb8500", alpha = 0.2) +
  tm_shape(aves_buffer_subset) +
  tm_dots(col = "#023047")
```

# 3. Find PAs within 15km of Goleta
Find the protected areas within 15 km of a city in Santa Barbara County
Hint: Use dplyr::filter() to select a city from sb_city_boundaries

```{r}
# Subset SB county to Goleta
goleta <- sb_city_boundaries |> 
  dplyr::filter(NAME == "Goleta")

st_crs(goleta)$units  # Check if units are in meters
```

```{r}
goleta_buffer_15km <- st_buffer(goleta, dist = 15000) # Create 15 km buffer around Goleta
```

# Explore different outputs for #3 with st_intersects(), st_intersection(), and st_within()
```{r}
goleta_PAs_within <- st_within(sb_protected_areas, goleta_buffer_15km)
```

```{r}
goleta_PAs_intersect <- st_intersects(sb_protected_areas, goleta_buffer_15km)
```

```{r}
goleta_PAs_intersection <- st_intersection(sb_protected_areas, goleta_buffer_15km)
```
# Practice a distance-based join with st_is_within_distance()
```{r}
goleta_PAs_join <- st_join(sb_protected_areas, goleta, st_is_within_distance, dist = 15000)
```

# 3. Find distance between Goleta and Dangermond Preserve
Find the distance between your city of choice and a protected area of your choice, using the geometriesâ€™ edges and the centroid
```{r}
# Subset PA to Dangermond Preserve
dangermond <- sb_protected_areas |>
  dplyr::filter(UNIT_NAME == "Jack and Laura Dangermond Preserve")
```

```{r}
danger_dist <- st_distance(goleta, dangermond) # Compute the distance between geometries edges
```


```{r}
# Calculate the geometric center
dangermond_centroid <- st_centroid(dangermond)
goleta_centroid <- st_centroid(goleta)

danger_dist_centroid <- st_distance(goleta_centroid, dangermond_centroid) # Compute the distance between geometries edges
```

```{r}
# Check if the distance matrices are equal
danger_dist == danger_dist_centroid
```

